{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block page_title %}Settings{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Settings Navigation -->
    <div class="col-md-3">
        <div class="card shadow-sm">
            <div class="list-group list-group-flush settings-nav">
                <a href="#account" class="list-group-item list-group-item-action active" data-bs-toggle="list">
                    <i class='bx bxs-user-circle me-2'></i>Account
                </a>
                <a href="#security" class="list-group-item list-group-item-action" data-bs-toggle="list">
                    <i class='bx bxs-lock-alt me-2'></i>Security
                </a>
                <a href="#notifications" class="list-group-item list-group-item-action" data-bs-toggle="list">
                    <i class='bx bxs-bell me-2'></i>Notifications
                </a>
                <a href="#appearance" class="list-group-item list-group-item-action" data-bs-toggle="list">
                    <i class='bx bxs-palette me-2'></i>Appearance
                </a>
            </div>
        </div>
    </div>

    <!-- Settings Content -->
    <div class="col-md-9">
        <div class="tab-content">
            <!-- Account Settings -->
            <div class="tab-pane fade show active" id="account">
                <div class="card shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0">Account Settings</h5>
                    </div>
                    <div class="card-body">
                        <form action="{{ url_for('main.update_settings') }}" method="POST" class="needs-validation" novalidate>
                            <div class="row mb-4">
                                <label class="col-sm-3 col-form-label">Username</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" value="{{ current_user.username }}" readonly>
                                    <small class="text-muted">Username cannot be changed</small>
                                </div>
                            </div>
                            <div class="row mb-4">
                                <label class="col-sm-3 col-form-label">Role</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" value="{{ current_user.role|title }}" readonly>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-sm-9 offset-sm-3">
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Security Settings -->
            <div class="tab-pane fade" id="security">
                <div class="card shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0">Security Settings</h5>
                    </div>
                    <div class="card-body">
                        <form action="{{ url_for('main.update_settings') }}" method="POST" class="needs-validation" novalidate>
                            <div class="mb-4">
                                <label class="form-label">Current Password</label>
                                <input type="password" class="form-control" name="current_password" required>
                                <div class="invalid-feedback">Please enter your current password</div>
                            </div>
                            <div class="mb-4">
                                <label class="form-label">New Password</label>
                                <input type="password" class="form-control" name="new_password" required>
                                <div class="invalid-feedback">Please enter a new password</div>
                            </div>
                            <div class="mb-4">
                                <label class="form-label">Confirm New Password</label>
                                <input type="password" class="form-control" name="confirm_password" required>
                                <div class="invalid-feedback">Please confirm your new password</div>
                            </div>
                            <button type="submit" class="btn btn-primary">Update Password</button>
                        </form>

                        <hr class="my-4">

                        <h6 class="mb-3">Two-Factor Authentication</h6>
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <p class="mb-0">Add an extra layer of security to your account</p>
                                <small class="text-muted">Currently disabled</small>
                            </div>
                            <button class="btn btn-outline-primary" disabled>Enable 2FA</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notification Settings -->
            <div class="tab-pane fade" id="notifications">
                <div class="card shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0">Notification Settings</h5>
                    </div>
                    <div class="card-body">
                        <form action="{{ url_for('main.update_settings') }}" method="POST">
                            <h6 class="mb-3">Email Notifications</h6>
                            <div class="mb-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="email_notifications" 
                                           id="emailNotifications" {{ 'checked' if current_user.email_notifications }}>
                                    <label class="form-check-label" for="emailNotifications">
                                        Receive email notifications
                                    </label>
                                </div>
                                <small class="text-muted">Get notified about grades, attendance, and important updates</small>
                            </div>

                            <h6 class="mb-3">SMS Notifications</h6>
                            <div class="mb-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="sms_notifications" 
                                           id="smsNotifications" {{ 'checked' if current_user.sms_notifications }}>
                                    <label class="form-check-label" for="smsNotifications">
                                        Receive SMS notifications
                                    </label>
                                </div>
                                <small class="text-muted">Get urgent notifications via SMS</small>
                            </div>

                            <button type="submit" class="btn btn-primary">Save Preferences</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Appearance Settings -->
            <div class="tab-pane fade" id="appearance">
                <div class="card shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0">Appearance Settings</h5>
                    </div>
                    <div class="card-body">
                        <form action="{{ url_for('main.update_settings') }}" method="POST">
                            <h6 class="mb-3">Theme</h6>
                            <div class="row g-3 mb-4">
                                <div class="col-auto">
                                    <div class="theme-option">
                                        <input type="radio" class="btn-check" name="theme" id="lightTheme" 
                                               value="light" {{ 'checked' if current_user.theme == 'light' }}>
                                        <label class="btn btn-outline-primary" for="lightTheme">
                                            <i class='bx bxs-sun me-2'></i>Light
                                        </label>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <div class="theme-option">
                                        <input type="radio" class="btn-check" name="theme" id="darkTheme" 
                                               value="dark" {{ 'checked' if current_user.theme == 'dark' }}>
                                        <label class="btn btn-outline-primary" for="darkTheme">
                                            <i class='bx bxs-moon me-2'></i>Dark
                                        </label>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <div class="theme-option">
                                        <input type="radio" class="btn-check" name="theme" id="systemTheme" 
                                               value="system" {{ 'checked' if current_user.theme == 'system' }}>
                                        <label class="btn btn-outline-primary" for="systemTheme">
                                            <i class='bx bxs-devices me-2'></i>System
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary">Save Preferences</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.settings-nav .list-group-item {
    border: none;
    padding: 1rem 1.25rem;
}

.settings-nav .list-group-item i {
    font-size: 1.25rem;
}

.settings-nav .list-group-item.active {
    background-color: rgba(var(--bs-primary-rgb), 0.1);
    color: var(--bs-primary);
    border-right: 3px solid var(--bs-primary);
}

.theme-option {
    display: inline-block;
}

.theme-option label {
    min-width: 120px;
}

.form-switch {
    padding-left: 3em;
}

.form-switch .form-check-input {
    width: 3em;
    margin-left: -3em;
}

.form-check-input:checked {
    background-color: var(--bs-primary);
    border-color: var(--bs-primary);
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form validation
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        });
    });

    // Password confirmation validation
    const newPasswordInput = document.querySelector('input[name="new_password"]');
    const confirmPasswordInput = document.querySelector('input[name="confirm_password"]');
    if (newPasswordInput && confirmPasswordInput) {
        confirmPasswordInput.addEventListener('input', function() {
            if (this.value !== newPasswordInput.value) {
                this.setCustomValidity('Passwords do not match');
            } else {
                this.setCustomValidity('');
            }
        });
    }
});
</script>
{% endblock %}

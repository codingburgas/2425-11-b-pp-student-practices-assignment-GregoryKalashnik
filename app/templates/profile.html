{% extends "base.html" %}

{% block title %}Profile{% endblock %}

{% block page_title %}My Profile{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Profile Overview Card -->
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-body text-center">
                <div class="profile-picture-wrapper mb-4">
                    <div class="profile-picture">
                        {% if current_user.profile_picture %}
                            <img src="{{ url_for('static', filename='uploads/' + current_user.profile_picture) }}" 
                                 alt="Profile Picture" class="img-fluid rounded-circle">
                        {% else %}
                            <div class="profile-initials rounded-circle">
                                {{ current_user.first_name[0] if current_user.first_name else '' }}{{ current_user.last_name[0] if current_user.last_name else '' }}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <h4 class="mb-1">{{ current_user.first_name }} {{ current_user.last_name }}</h4>
                <p class="text-muted mb-3">{{ current_user.role|title }}</p>
                <div class="d-flex justify-content-center gap-2">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                        <i class='bx bxs-edit me-1'></i>Edit Profile
                    </button>
                    <a href="{{ url_for('main.settings') }}" class="btn btn-light">
                        <i class='bx bxs-cog me-1'></i>Settings
                    </a>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="card shadow-sm mt-4">
            <div class="card-body">
                <h5 class="card-title mb-4">Quick Stats</h5>
                <div class="quick-stats">
                    {% if current_user.is_teacher() %}
                    <div class="stat-item">
                        <i class='bx bxs-graduation text-primary'></i>
                        <div class="stat-details">
                            <span class="stat-label">Total Students</span>
                            <span class="stat-value">{{ students|length }}</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <i class='bx bxs-book text-success'></i>
                        <div class="stat-details">
                            <span class="stat-label">Subjects</span>
                            <span class="stat-value">{{ subjects|length }}</span>
                        </div>
                    </div>
                    {% else %}
                    <div class="stat-item">
                        <i class='bx bxs-graduation text-primary'></i>
                        <div class="stat-details">
                            <span class="stat-label">Average Grade</span>
                            <span class="stat-value">{{ "%.1f"|format(student.average_grade|default(0)) }}%</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <i class='bx bxs-calendar-check text-success'></i>
                        <div class="stat-details">
                            <span class="stat-label">Attendance Rate</span>
                            <span class="stat-value">{{ "%.1f"|format(student.attendance_rate|default(0)) }}%</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Details -->
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0">Profile Information</h5>
            </div>
            <div class="card-body">
                <div class="profile-details">
                    <div class="detail-item">
                        <span class="detail-label">Full Name</span>
                        <span class="detail-value">{{ current_user.first_name }} {{ current_user.last_name }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Email</span>
                        <span class="detail-value">{{ current_user.email }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Username</span>
                        <span class="detail-value">{{ current_user.username }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Role</span>
                        <span class="detail-value">{{ current_user.role|title }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Member Since</span>
                        <span class="detail-value">{{ current_user.created_at.strftime('%B %d, %Y') if current_user.created_at else 'Not Available' }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card shadow-sm mt-4">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0">Recent Activity</h5>
            </div>
            <div class="card-body">
                <div class="timeline">
                    {% for activity in activities[:5] %}
                    <div class="timeline-item">
                        <div class="timeline-icon bg-{{ activity.type }}">
                            <i class='bx bxs-{{ activity.icon }}'></i>
                        </div>
                        <div class="timeline-content">
                            <h6 class="mb-1">{{ activity.title }}</h6>
                            <p class="text-muted mb-0">{{ activity.description }}</p>
                            <small class="text-muted">{{ activity.timestamp.strftime('%B %d, %Y at %I:%M %p') }}</small>
                        </div>
                    </div>
                    {% else %}
                    <p class="text-muted text-center mb-0">No recent activity</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('main.update_profile') }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Profile Picture</label>
                        <input type="file" class="form-control" name="profile_picture" accept="image/*">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">First Name</label>
                        <input type="text" class="form-control" name="first_name" 
                               value="{{ current_user.first_name }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Last Name</label>
                        <input type="text" class="form-control" name="last_name" 
                               value="{{ current_user.last_name }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email" 
                               value="{{ current_user.email }}" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.profile-picture-wrapper {
    position: relative;
    width: 150px;
    height: 150px;
    margin: 0 auto;
}

.profile-picture {
    width: 150px;
    height: 150px;
    object-fit: cover;
    border: 4px solid #fff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.profile-picture-placeholder {
    width: 150px;
    height: 150px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #e9ecef;
    font-size: 2.5rem;
    font-weight: bold;
    color: #6c757d;
    border: 4px solid #fff;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.quick-stats {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.stat-item i {
    font-size: 2rem;
    padding: 0.5rem;
    background-color: rgba(var(--bs-primary-rgb), 0.1);
    border-radius: 0.5rem;
}

.stat-details {
    display: flex;
    flex-direction: column;
}

.stat-label {
    font-size: 0.875rem;
    color: #6c757d;
}

.stat-value {
    font-size: 1.25rem;
    font-weight: 600;
}

.profile-details {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.detail-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e9ecef;
}

.detail-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.detail-label {
    color: #6c757d;
    font-weight: 500;
}

.detail-value {
    font-weight: 500;
}

.timeline {
    position: relative;
    padding: 1rem 0;
}

.timeline-item {
    display: flex;
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.timeline-item:last-child {
    margin-bottom: 0;
}

.timeline-icon {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
}

.timeline-icon i {
    font-size: 1.25rem;
}

.timeline-content {
    flex-grow: 1;
}
</style>
{% endblock %}
